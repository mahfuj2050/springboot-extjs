<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Product Management - ExtJS Version</title>
    
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/extjs/6.2.0/classic/theme-triton/resources/theme-triton-all.css">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/extjs/6.2.0/ext-all.js"></script>
    
    <style>
        /* Ensure header is sticky */
        .sticky-header {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            background-color: #fff;
            border-bottom: 1px solid #ccc;
        }
        /* Adjust content to avoid overlap with sticky header */
        .x-viewport > .x-body {
            margin-top: 50px; /* Adjust based on header height */
        }
    </style>
    
    <script type="text/javascript">
        window.onerror = function(msg, url, line) {
            console.error('Error:', msg, 'Line:', line);
            return false;
        };
        
        Ext.onReady(function() {
            console.log('ExtJS Ready - Version:', Ext.getVersion().version);
            
            // Define Product Model
            Ext.define('Product', {
                extend: 'Ext.data.Model',
                fields: [
                    { name: 'id', type: 'int', allowNull: true },
                    { name: 'name', type: 'string' },
                    { name: 'description', type: 'string' },
                    { name: 'price', type: 'float' },
                    { name: 'quantity', type: 'int' }
                ],
                idProperty: 'id',
                clientIdProperty: null
            });
            
            // Define Product Store
            var store = Ext.create('Ext.data.Store', {
                model: 'Product',
                proxy: {
                    type: 'rest',
                    url: 'http://localhost:8080/api/products',
                    appendId: true,
                    reader: {
                        type: 'json',
                        rootProperty: 'data',
                        successProperty: 'success'
                    },
                    writer: {
                        type: 'json',
                        writeAllFields: true,
                        transform: {
                            fn: function(data, request) {
                                if (request.getAction() === 'create') {
                                    console.log('Writer transforming data:', data);
                                    delete data.id;
                                }
                                return data;
                            }
                        }
                    },
                    actionMethods: {
                        create: 'POST',
                        read: 'GET',
                        update: 'PUT',
                        destroy: 'DELETE'
                    },
                    api: {
                        create: 'http://localhost:8080/api/products'
                    }
                },
                autoLoad: true,
                listeners: {
                    load: function(store, records, successful) {
                        console.log('Store loaded:', successful, 'Records:', records.length);
                    }
                }
            });
            
            // Function to show Product Form
            function showProductForm(record) {
                var form = Ext.create('Ext.window.Window', {
                    title: record ? 'Edit Product' : 'Add Product',
                    width: 400,
                    modal: true,
                    layout: 'fit',
                    items: [{
                        xtype: 'form',
                        bodyPadding: 10,
                        defaults: {
                            anchor: '100%',
                            labelWidth: 100
                        },
                        items: [{
                            xtype: 'textfield',
                            name: 'name',
                            fieldLabel: 'Name',
                            allowBlank: false
                        }, {
                            xtype: 'textfield',
                            name: 'description',
                            fieldLabel: 'Description'
                        }, {
                            xtype: 'numberfield',
                            name: 'price',
                            fieldLabel: 'Price',
                            allowBlank: false,
                            minValue: 0,
                            decimalPrecision: 2
                        }, {
                            xtype: 'numberfield',
                            name: 'quantity',
                            fieldLabel: 'Quantity',
                            value: 0,
                            minValue: 0,
                            allowDecimals: false
                        }]
                    }],
                    buttons: [{
                        text: 'Save',
                        handler: function() {
                            var win = this.up('window'),
                                formPanel = win.down('form'),
                                values = formPanel.getValues();
                            
                            console.log('Form values before processing:', values);
                            
                            if (formPanel.isValid()) {
                                if (record) {
                                    console.log('Editing record with ID:', record.getId());
                                    record.set(values);
                                } else {
                                    delete values.id;
                                    console.log('Form values after removing id:', values);
                                    record = Ext.create('Product', values);
                                    store.add(record);
                                }
                                
                                console.log('Record data before sync:', record.getData());
                                store.sync({
                                    success: function() {
                                        console.log('Sync successful');
                                        Ext.toast('Product saved successfully!');
                                        store.reload();
                                        win.close();
                                    },
                                    failure: function(batch) {
                                        console.log('Sync failed:', batch.exceptions);
                                        Ext.toast('Failed to save product');
                                        store.reload();
                                    }
                                });
                            } else {
                                console.log('Form is invalid:', formPanel.getForm().getErrors());
                                Ext.toast('Please fill out all required fields');
                            }
                        }
                    }, {
                        text: 'Cancel',
                        handler: function() {
                            this.up('window').close();
                        }
                    }]
                });
                
                if (record) {
                    form.down('form').loadRecord(record);
                }
                
                form.show();
            }
            
            // Define Product Grid
            var productGrid = Ext.create('Ext.grid.Panel', {
                title: 'Product Management',
                store: store,
                columns: [{
                    text: 'ID',
                    dataIndex: 'id',
                    width: 60
                }, {
                    text: 'Name',
                    dataIndex: 'name',
                    flex: 1
                }, {
                    text: 'Description',
                    dataIndex: 'description',
                    flex: 2
                }, {
                    text: 'Price',
                    dataIndex: 'price',
                    width: 100,
                    renderer: function(value) {
                        return '$' + Ext.util.Format.number(value, '0.00');
                    }
                }, {
                    text: 'Quantity',
                    dataIndex: 'quantity',
                    width: 100
                }, {
                    xtype: 'actioncolumn',
                    text: 'Actions',
                    width: 100,
                    items: [{
                        iconCls: 'x-fa fa-edit',
                        tooltip: 'Edit',
                        handler: function(grid, rowIndex) {
                            var record = grid.getStore().getAt(rowIndex);
                            showProductForm(record);
                        }
                    }, {
                        iconCls: 'x-fa fa-trash',
                        tooltip: 'Delete',
                        handler: function(grid, rowIndex) {
                            var record = grid.getStore().getAt(rowIndex);
                            Ext.Msg.confirm('Confirm', 'Delete this product?', function(btn) {
                                if (btn === 'yes') {
                                    store.remove(record);
                                    store.sync({
                                        success: function() {
                                            Ext.toast('Product deleted successfully!');
                                            store.reload();
                                        },
                                        failure: function() {
                                            Ext.toast('Failed to delete product');
                                            store.reload();
                                        }
                                    });
                                }
                            });
                        }
                    }]
                }],
                tbar: [{
                    text: 'Add Product',
                    iconCls: 'x-fa fa-plus',
                    handler: function() {
                        showProductForm(null);
                    }
                }, {
                    text: 'Refresh',
                    iconCls: 'x-fa fa-refresh',
                    handler: function() {
                        store.reload();
                    }
                }]
            });
            
            // Define Placeholder View for Other Pages
            var settingsView = Ext.create('Ext.panel.Panel', {
                title: 'Settings',
                html: '<h2>Settings Page</h2><p>This is a placeholder for the settings page.</p>'
            });
            
            // Main Viewport with Border Layout
            Ext.create('Ext.container.Viewport', {
                layout: 'border',
                items: [{
                    region: 'north',
                    xtype: 'panel',
                    cls: 'sticky-header',
                    height: 50,
                    layout: {
                        type: 'hbox',
                        align: 'middle',
                        pack: 'start'
                    },
                    items: [{
                        xtype: 'component',
                        html: '<h1 style="margin: 0 20px;">Product Management System</h1>'
                    }, {
                        xtype: 'tbspacer',
                        flex: 1
                    }, {
                        xtype: 'button',
                        text: 'Logout',
                        iconCls: 'x-fa fa-sign-out',
                        handler: function() {
                            Ext.Msg.alert('Logout', 'Logout functionality not implemented.');
                        }
                    }],
                    listeners: {
                        afterrender: function() {
                            console.log('Header rendered');
                        }
                    }
                }, {
                    region: 'west',
                    xtype: 'treepanel',
                    title: 'Navigation',
                    width: 250,
                    collapsible: true,
                    split: true,
                    rootVisible: false,
                    store: {
                        root: {
                            expanded: true,
                            children: [
                                { text: 'Product Management', leaf: true, view: 'productGrid' },
                                { text: 'Settings', leaf: true, view: 'settingsView' }
                            ]
                        }
                    },
                    listeners: {
                        select: function(selModel, record) {
                            var contentPanel = Ext.getCmp('content-panel');
                            var view = record.get('view');
                            if (view === 'productGrid') {
                                contentPanel.setActiveItem(productGrid);
                            } else if (view === 'settingsView') {
                                contentPanel.setActiveItem(settingsView);
                            }
                            console.log('Tree node selected:', record.get('text'));
                        }
                    }
                }, {
                    region: 'center',
                    xtype: 'panel',
                    id: 'content-panel',
                    layout: 'card',
                    activeItem: 0,
                    items: [productGrid, settingsView],
                    listeners: {
                        afterrender: function() {
                            console.log('Content panel rendered');
                        }
                    }
                }]
            });
            
            console.log('Application initialized successfully');
        });
    </script>
</head>
<body></body>
</html>